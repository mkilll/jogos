<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Jogo de Tiro 3D</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { margin:0; overflow:hidden; background:#181d25;}
    #hud {
      position: absolute; top: 12px; left: 12px; color: #fff; z-index: 10;
      font-family: 'Segoe UI', Arial, sans-serif; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px;
      font-size: 18px;
    }
    #hud button { margin-top:8px; margin-right:12px; font-size:16px;}
  </style>
</head>
<body>
  <div id="hud">
    <span id="ammo"></span> |
    <span id="score"></span>
    <br>
    <button onclick="reloadWeapon()">Recarregar [R]</button>
    <span id="msg"></span>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/controls/PointerLockControls.js"></script>
  <script>
    // Setup Three.js scene
    let scene = new THREE.Scene();
    scene.background = new THREE.Color(0x181d25);

    let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);

    let renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lighting
    scene.add(new THREE.AmbientLight(0x404060, 0.7));
    let light = new THREE.DirectionalLight(0xffffff, 1.2);
    light.position.set(10, 20, 10);
    scene.add(light);

    // Floor
    let floorGeometry = new THREE.BoxGeometry(100, 1, 100);
    let floorMaterial = new THREE.MeshPhongMaterial({ color: 0x242c38 });
    let floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.position.y = -1;
    scene.add(floor);

    // HUD
    let ammoHud = document.getElementById("ammo");
    let scoreHud = document.getElementById("score");
    let msgHud = document.getElementById("msg");
    let score = 0;

    // Player controls
    let controls = new THREE.PointerLockControls(camera, document.body);
    document.body.addEventListener('click', () => controls.lock());
    camera.position.set(0, 2, 5);

    // Gun model
    function createGun() {
      let gun = new THREE.Group();
      let body = new THREE.Mesh(
        new THREE.BoxGeometry(0.8, 0.26, 2),
        new THREE.MeshPhongMaterial({ color: 0x333333 })
      );
      body.position.z = -1.2;
      gun.add(body);

      let barrel = new THREE.Mesh(
        new THREE.CylinderGeometry(0.09, 0.09, 1.2, 16),
        new THREE.MeshPhongMaterial({ color: 0x666666 })
      );
      barrel.rotation.x = Math.PI / 2;
      barrel.position.z = -2;
      gun.add(barrel);

      let grip = new THREE.Mesh(
        new THREE.BoxGeometry(0.2, 0.5, 0.22),
        new THREE.MeshPhongMaterial({ color: 0x222222 })
      );
      grip.position.set(0, -0.3, -0.6);
      gun.add(grip);

      gun.position.set(0.5, -0.42, -1.2); // In-camera position
      return gun;
    }
    let gun = createGun();
    camera.add(gun);

    // Weapon state
    let maxAmmo = 10;
    let ammo = maxAmmo;
    let reserveAmmo = 30;

    // Enemies
    let enemies = [];
    function spawnEnemy() {
      let enemyGeo = new THREE.SphereGeometry(0.6, 18, 18);
      let enemyMat = new THREE.MeshPhongMaterial({ color: 0xff4444 });
      let enemy = new THREE.Mesh(enemyGeo, enemyMat);
      enemy.position.set(
        (Math.random()-0.5)*30,
        0.6,
        -Math.random()*30-8
      );
      enemy.userData.alive = true;
      scene.add(enemy);
      enemies.push(enemy);
    }
    for (let i=0; i<9; i++) spawnEnemy();

    // HUD update
    function updateHud() {
      ammoHud.textContent = `Munição: ${ammo} / ${reserveAmmo}`;
      scoreHud.textContent = `Pontos: ${score}`;
    }
    updateHud();

    // Shooting
    function shoot() {
      if (ammo <= 0) {
        msgHud.textContent = "Sem munição! Recarregue.";
        return;
      }
      ammo--;
      msgHud.textContent = "";
      updateHud();

      let raycaster = new THREE.Raycaster();
      let dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
      raycaster.set(camera.position, dir);
      let intersects = raycaster.intersectObjects(enemies);
      for (let i = 0; i < intersects.length; i++) {
        let obj = intersects[i].object;
        if (obj.userData.alive) {
          obj.userData.alive = false;
          obj.material.color.set(0x222222);
          score += 100;
          updateHud();
          msgHud.textContent = "Inimigo abatido!";
          break;
        }
      }
    }

    // Reload
    function reloadWeapon() {
      if (ammo === maxAmmo || reserveAmmo === 0) {
        msgHud.textContent = "Não há necessidade ou munição!";
        return;
      }
      let needed = maxAmmo - ammo;
      let take = Math.min(needed, reserveAmmo);
      ammo += take;
      reserveAmmo -= take;
      msgHud.textContent = "Recarregado!";
      updateHud();
    }
    window.reloadWeapon = reloadWeapon;

    // Key controls
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space' || e.code === 'Mouse0') shoot();
      if (e.code === 'KeyR') reloadWeapon();
    });

    // Movement
    let move = { f:0, b:0, l:0, r:0 };
    window.addEventListener('keydown', (e) => {
      if (e.code === 'KeyW') move.f=1;
      if (e.code === 'KeyS') move.b=1;
      if (e.code === 'KeyA') move.l=1;
      if (e.code === 'KeyD') move.r=1;
    });
    window.addEventListener('keyup', (e) => {
      if (e.code === 'KeyW') move.f=0;
      if (e.code === 'KeyS') move.b=0;
      if (e.code === 'KeyA') move.l=0;
      if (e.code === 'KeyD') move.r=0;
    });

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);

      // Movement
      let speed = 0.16;
      let dir = new THREE.Vector3();
      if (move.f) dir.z -= speed;
      if (move.b) dir.z += speed;
      if (move.l) dir.x -= speed;
      if (move.r) dir.x += speed;
      controls.moveRight(dir.x);
      controls.moveForward(dir.z);

      // Enemy movement
      enemies.forEach(enemy => {
        if (enemy.userData.alive) {
          enemy.position.x += (Math.random()-0.5)*0.09;
          enemy.position.z += (Math.random()-0.5)*0.09;
        }
      });

      renderer.render(scene, camera);
    }
    animate();

    // Responsive
    window.addEventListener('resize',()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
